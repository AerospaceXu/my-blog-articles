# 说说跨域

本文写于 2020 年 6 月 17 日

大家有被盗号的经历吗？

就是那种，对盗来的号的每个好友发送一遍：“xxx，在吗？借我 200 块钱，江湖救急！”

这是多恐怖的事情。

假设你登录了网页版 QQ，我们知道所有的数据其实都是 JS 请求服务器得来的。

那如果我写一个“黑客网站”，你只要打开我的网站，我就会请求 QQ 的服务器，以得到你的 QQ 数据，这样就能向每一个好友借一遍钱（嘿嘿嘿）。

黑客网站发送的请求和官方网站发送的请求有什么区别呢？

答：refer 不同。

我们可以打开开发者工具，进入 Network，筛选出 XHR（就是 XMLHttpRequest 对象），就可以看到我们发送过的 Ajax 请求。请求中有一个特殊的字段：Referer，它就是发送请求的网站域名，比如百度发的请求，referer 就是 `https://www.baidu.com`。

那既然如此，我们完全可以在后台检测 referer，这样就可以知道请求是从哪里发来的，从而实现「同源」。

但是万一程序员忘记了怎么办？浏览器应该主动的预防这种偷数据的行为！

## 同源是什么？

综上所述，浏览器为了用户隐私，设置了严格的同源策略。

所谓同源策略，就是说**如果 JS 运行在源 A 中，那么就只允许 JS 获取源 A 的数据，不允许获取源 B 或 C 或 D 的数据**——比如刚刚说的黑客 QQ 空间。

那如果 `mywebsite.com` 引用了 `cdn.com/jQuery.js`，这算是跨域吗？

不算，因为 `jQuery.js` 是运行在 `baidu.com` 中的，他和 `cdn.com` 毫无关系——虽然 `jQuery.js` 是从他那里下载的。

可以说**浏览器安全的基石就是“同源政策”。**

在 1995 年，同源政策由**网景**引入了浏览器。并且到目前为止，**所有浏览器**都在实行这个政策。

最初它的含义是指：**A 网页设置的 Cookie，B 网页不能打开，除非这两个网页"同源"**。

这里所谓的“同源”指的是三个相同：

1. 协议相同
2. 域名相同
3. 端口相同

协议、域名和端口这三样在我之前一篇文章中讲过，都是 URL 的组成部分。

比如说 `https://www.baidu.com:8080` 中，`https://` 就是协议，`www.baidu.com` 就是域名，`:8080` 就是端口号。

这三个东西必须**严格相同**，否则浏览器将视为**不同源**。

举几个例子：

- `baidu.com` 和 `www.baidu.com` 不同源（域名不同）；
- `www.baidu.com/s` 和 `www.baidu.com` 同源；
- `http://www.baidu.com:8080` 和 `https://www.baidu.com:8080` 不同源（协议不同）；
- `baidu.com:8080` 和 `baidu.com:80` 不同源（端口不同）。

**不同源好不好？**

刚刚说了黑客网页可以偷走你正在访问的网页的一些数据，甚至进行一些操作。这是怎么做的呢？

其实就是 Cookie。所谓 Cookie 就是“小型文本文件”，是网站为了辨别用户身份而储存在浏览器本地上的数据。

如果她包含了某些隐私信息，比如支付宝余额，让黑客网站随便就拿到了，对用户隐私将会是极大的损害。

甚至于 Cookie 有时会保存登录信息，如果没有「同源策略」，黑客网站就能像文章开头所说的那样，直接操作你的账户！

现在，随着互联网的发展，"同源政策"越来越严格。**目前如果不是同源，共有三种行为受到限制：**

1. Cookie, LocalStorage, IndexDB 无法读取；
2. DOM 无法获得；
3. AJAX 请求不能发送。

## 跨域

刚刚说了很多因为「同源策略」而不能实现的操作。但是如果我真的需要操作这些怎么办呢？

比如两个网站有某些合作，甚至说这俩网站本来就都是我的，该怎么办？

这就需要用到**跨域**了。

先看看维基百科的解释：

> 跨域资源共享，用于让网页的受限资源能够被其他域名的页面访问的一种机制。
>
> 通过该机制，页面能够自由地使用不同源的图片、样式、脚本、iframes 以及视频。
>
> 一些跨域的请求常常会被同源策略所禁止的。
>
> 跨源资源共享定义了一种方式，为的是浏览器和服务器之间能互相确认是否足够安全以至于能使用跨源请求

### 1. CORS

跨域有许多种方法，先说最常见也是比较新的一种方式：**CORS**。

CORS 是一个需要浏览器和服务器同时支持的技术。

首先需要先进行声明，在 a 网站**响应头**里写上，b 网站可以访问就行了！

涉及该操作的属性是`Access-Control-Allow-Origin`。顾名思义嘛，访问-控制-允许-源。

比如 Node.js 的后台程序，可以写成如下形式：

```javascript
if (path === 'user.json') {
  response.setHeader('Content-Type', 'text/json;charset=utf-8');
  response.setHeader('Access-Control-Allow-Origin', 'https://b.com');
  response.end();
}
```

就可以使 b 网站成功通过 Ajax 拿到 a 网站的 user.json。
