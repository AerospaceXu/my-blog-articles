# 思索 p5.js 的最佳实践

<!-- TODO: 本文写于 2020 年 12 月 -->

p5.js 是一个 JavaScript 库，用于为艺术家、设计师提供更容易上手的创意编程。

它有着完整的一套基于 Canvas 的作画功能，并且你可以把整个浏览器都当成你的“画布”——利用 `p5.dom.js` 可以很方便地与其他 HTML 元素进行交互；利用 `p5.sound.js` 可以很简单的对声音进行分析与处理。

## 官网推荐用法

在官网的例子中，推荐使用 `<script>` 标签引入的方法：

```html
<html>
  <head>
    <!-- ...... -->
    <script src="path/to/your/p5.js"></script>
  </head>
  <body>
    <script>
      function setup() {
        createCanvas(300, 500);
      }

      function draw() {}
    </script>
  </body>
</html>
```

这样是让所有的变量、函数都暴露在全局之下，所以我们可以直接使用 `setup`, `draw` 函数进行操作。

但这对于新手来说，这样的做法存在一个致命问题：**没有代码提示**。并且也不符合我们现代 Web 开发的习惯——**模块化**。

在动画复杂的情况下，代码会越来越多、越来越邋遢，直到成为一座“屎山”！！！

所以这让我不由得思考起了 p5.js 的最佳实践究竟该如何。

## 安装环境

需要：`Node.js v14.1` 及以上。

上官网下载并安装 Node.js 后，命令行输入 `node -v` 查看是否安装成功。再输入 `npm -v` 查看是否成功安装 npm。

不理解 npm 是什么的可以看这一篇：[npm 是什么？](https://www.cnblogs.com/xhyccc/p/13260541.html)。

输入 `npm config set registry https://registry.npm.taobao.org` 将下载源更改为国内地址。

访问[GitHub 仓库](https://github.com/AerospaceXu/template-p5)下载我事先准备好的模板代码，并进入目录，输入：`npm install` 安装依赖。

## 步入现代

接下来我们就要进入现代化的 Web 开发了。

要求：

- 了解 `import/export`；
- 了解面向对象编程。

推荐使用 TypeScript，这样才能获得更完善的面向对象的开发体验与类型提示。

### 目录分析

使用编辑器打开刚刚下载的 `template-p5` 文件，观察目录。

我们只需要关注 src 目录即可。

#### main.ts

首先是 index.html，引入了 main.ts。在该文件中，我们为 window 添加了一个 load 事件，也就是希望在所有的 DOM 元素都加载完毕后才开始执行我们的代码。

```ts
// main.ts
import App from './App';
import './styles/index.css';

// 确保在 DOM 元素全部加载完毕后再加载代码
window.addEventListener('load', App);
```

#### App.ts

该文件拥有一个函数，该函数就是我们的应用代码。目前我们的应用代码只需要做一件事情：创建 p5 的 canvas。

```ts
// app.ts
import Sketch from './components/Sketch';

const App = () => {
  const sketch = new Sketch();
  sketch.initSketchBoard();
};

export default App;
```

这里的 Sketch 是什么？是一个 class。他的内容是什么呢？

**这就要提到 p5 的另一种写法了。**

通过查阅资料，我们发现 p5 除了之前的写法，还有另外一种：

```ts
import P5 from 'p5';

const sketch = (p: P5) => {
  p.setup = () => {
    p.createCapture(300, 400);
    p.background(0);
  };

  p.draw = () => {};
};

new P5(sketch, document.querySelector('#sketch'));
```

所以上面的代码就变得容易看懂了，肯定是在 `new Sketch()` 时，创建了函数，并在 `initSketchBoard` 方法里，对 `P5` 进行了实例化。

这时候，有些人就要说了：**我凭什么要这么写啊？！**搞这么麻烦，多写了乱七八糟的代码不说，所有 p5 函数的调用都需要写一个 `p.xxx`，想累死我嘛？

但是对比起好处，这个坏处就不值一提了：

1. **这样写有代码提示**，输入 `p.` 后会自动弹出**代码提示与自动补全**，方法的参数、类型都会明明白白的提示给你；
2. 原来的写法不能很好的进行模块化，如果需要模块化我们必须这么写，模块化可以让我们更好的对项目进行 debug。

#### Sketch.ts

到了这里应该很多新手就看不懂了。嘿嘿。

好吧，让我们一步一步来。

```ts
class Sketch {
  @Inject() private p5Service: P5Service;

  private sketchBoard: HTMLDivElement;

  constructor() {
    this.sketchBoard = document.querySelector('#sketch') as HTMLDivElement;
  }

  initSketchBoard() {
    new P5((p: P5) => {
      this.p5Service.injectP5(p);

      p.preload = () => this.p5Service.preload();

      p.setup = () => this.p5Service.setup();

      p.draw = () => this.p5Service.draw();
    }, this.sketchBoard);
  }
}
```

（完）
